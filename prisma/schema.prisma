// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Using SQLite for development, change to postgresql for production
  url      = env("DATABASE_URL")
}

// ============================================
// EXISTING MODELS (Battery-specific)
// ============================================

model Cell {
  id           String  @id @default(cuid())
  name         String
  chemistry    String   // LFP/NMC/NCA/LCO/LTO
  nominalV     Float
  capacityAh   Float
  contDischargeA Float
  peakDischargeA Float
  maxChargeA   Float
  internalRmOhm Float   // mΩ
  maxChargeV   Float
  cutOffV      Float
  weight_g     Float
  width_mm     Float
  height_mm    Float
  length_mm    Float
  grade        String?  // bin/grade
  manufacturer String?
  dateCode     String?
  datasheetUrl String?
  msdsUrl      String?
  testReportUrl String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model BMS {
  id            String  @id @default(cuid())
  name          String
  seriesMin     Int
  seriesMax     Int
  chemistry     String   // LFP/NMC...
  contA         Int
  peakA         Int
  ovpV          Float    // over-voltage per cell
  uvpV          Float    // under-voltage per cell
  ocpA          Int?     // over-current protection
  scpA          Int?     // short-circuit protection
  balanceType   String   // passive/active
  comms         String?  // UART/CAN/SMBus/BT
  ntcCount      Int?
  pinoutDocUrl  String?
  wiringGuideUrl String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Charger {
  id            String  @id @default(cuid())
  name          String
  outV          Float
  outA          Float
  profile       String // CC-CV / programlanabilir
  connector     String
  efficiency    Float?
  pfc           Boolean?
  noiseNote     String?
  protections   String?
  datasheetUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Accessory {
  id       String  @id @default(cuid())
  name     String
  type     String  // fish paper, kapton, nikel strip, thermal pad...
  specs    String? // dielektrik, sıcaklık dayanımı vb. serbest JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Case {
  id        String  @id @default(cuid())
  name      String
  material  String // ABS/Alüminyum
  ipRating  String?
  width_mm  Float
  height_mm Float
  length_mm Float
  mountInfo String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Connector {
  id        String  @id @default(cuid())
  name      String  // XT60/XT90/Anderson/M8 stud
  type      String  // yük/şarj
  contA     Int
  peakA     Int?
  antiSpark Boolean?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doc {
  id        String  @id @default(cuid())
  title     String
  type      String // MSDS/UN38.3/IEC62133/Guide
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project { // Kullanıcı konfigürasyonları
  id          String  @id @default(cuid())
  name        String
  mode        String  // beginner/pro
  scenario    String? // e-bike/UPS/robot/UAV...
  targetV     Float?
  targetWh    Float?
  targetA     Float?
  weightMaxG Float?
  tempMinC    Float?
  tempMaxC    Float?
  budgetTry   Float?
  notes       String?
  ns          Int?
  np          Int?
  cellId      String?
  bmsId       String?
  chargerId   String?
  connectorLoadId String?
  connectorChargeId String?
  caseId      String?
  bomJson     String? // oluşturulan BOM JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// E-COMMERCE MODELS (Engineering-focused)
// ============================================

enum Lifecycle {
  ACTIVE
  NRF  // Not Recommended for New Designs
  EOL  // End of Life
  OBSOLETE
}

enum OrderStatus {
  PENDING
  PAID
  PICKING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RFQStatus {
  DRAFT
  SUBMITTED
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
}

model Category {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  nameEn      String?  // English name for i18n
  description String?
  descriptionEn String?
  parentId    String?
  parent      Category? @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  image       String?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
  @@index([slug])
}

model Product {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String
  nameEn        String?  // English name for i18n
  brand         String?
  mpn           String?  // Manufacturer Part Number
  sku           String?  // Internal SKU (base)
  hsCode        String?  // Harmonized System Code
  lifecycle     Lifecycle @default(ACTIVE)
  certifications Json?   // { rohs:true, reach:true, ce:true, ip:"IP67" }
  specs         Json     // Parametric key-values with units: { voltage_min: 12, voltage_max: 24, current_max: 10, power: 120, ... }
  attributes    Json?    // Free-form attributes
  description   String?
  descriptionEn String?
  fullDescription String?
  fullDescriptionEn String?
  datasheets    Json?    // [{title,url,type:'pdf'|'step'|'iges'}]
  images        Json?    // [{url,alt,order}]
  videoUrl      String?  // YouTube/demo video URL
  badges        Json?    // [{type:'new'|'discount'|'bestseller'|'out_of_stock', text, color}]
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants      Variant[]
  priceRules    PriceRule[]
  compatibleWith Product[] @relation("ProductCompatibility")
  compatibleProducts Product[] @relation("ProductCompatibility")
  similarProducts Product[] @relation("ProductSimilarity")
  similarToProducts Product[] @relation("ProductSimilarity")
  leadTimeDays  Int?     // Typical lead time in days
  moq           Int?     // Minimum order quantity
  orderStep     Int?     // Must be multiple of X
  isFeatured    Boolean  @default(false)
  active        Boolean  @default(true)
  zoomEnabled   Boolean  @default(true) // Image zoom feature
  socialShareEnabled Boolean @default(true) // Social media sharing
  b2bPriceVisible Boolean @default(false) // Show B2B prices
  reviews       Review[]
  questions     ProductQuestion[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([mpn])
  @@index([sku])
  @@index([lifecycle])
  @@index([isFeatured, active])
  // Note: GIN index for JSONB search should be created manually in PostgreSQL
  // CREATE INDEX idx_product_specs_gin ON "Product" USING GIN (specs);
}

model Variant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku       String   @unique
  matrix    Json     // e.g. {"voltage":"24V","current":"10A","shaftType":"D-shaft"}
  specs     Json?    // Overrides or precise values for this variant
  price     Float
  currency  String   @default("TRY")
  vatRate   Float    // KDV % (e.g. 20.00 for 20%)
  weightG   Int?     // Weight in grams
  barcode   String?
  isActive  Boolean  @default(true)
  stock     Stock?
  orderLines OrderLine[]
  cartItems CartItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sku])
  @@index([isActive])
}

model Stock {
  id         String   @id @default(cuid())
  variantId  String   @unique
  variant    Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  onHand     Int      @default(0) // Physical stock
  reserved   Int      @default(0) // In carts/orders
  incoming   Int      @default(0) // Purchase orders
  lot        String?  // Lot number
  serials    Json?    // Array of serials if tracked
  location   String?  // Bin/shelf location
  updatedAt  DateTime @updatedAt

  @@index([variantId])
}

model PriceRule {
  id          String   @id @default(cuid())
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  categoryId  String?
  name        String
  type        String   // "tiered" | "b2b_group" | "campaign"
  minQty      Int?     // For tiered pricing
  maxQty      Int?
  discountPct Float? // Discount percentage
  discountAmount Float? // Fixed discount amount
  b2bGroupId  String?  // For B2B group pricing
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([categoryId])
  @@index([active, startDate, endDate])
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String?  // Hashed password (nullable for OAuth)
  name            String
  phone           String?
  role            String   @default("customer") // customer, admin, b2b
  b2bGroupId      String?  // For B2B pricing
  customerNo      String?  @unique // Müşteri numarası: CUS-NNNNN, otomatik atanır
  emailVerified   Boolean  @default(false)
  emailVerificationToken String?  @unique // Token for email verification
  emailVerificationExpires DateTime? // Token expiration
  resetToken      String?  @unique // Token for password reset
  resetTokenExpiry DateTime? // Password reset token expiration
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  addresses       Address[]
  orders          Order[]
  favorites       Favorite[]
  cart            Cart?
  billingProfiles BillingProfile[]
  rfqs            RFQ[]
  reviews         Review[]
  questions       ProductQuestion[]
}

// Sipariş ve müşteri numarası için global sıra (unique ORD-YYYY-NNNNN, CUS-NNNNN)
model Sequence {
  name            String   @id // 'orderNo' | 'customerNo'
  value           Int      @default(0)
  updatedAt       DateTime @updatedAt
}

model Address {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String   // Ev, İş, vb.
  name            String
  phone           String
  addressLine     String
  city            String
  district        String
  postalCode      String
  country         String   @default("Türkiye")
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model BillingProfile {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String
  companyName     String?
  taxId           String?  // VKN
  taxOffice       String?
  address         String
  city            String
  district        String
  postalCode      String
  country         String   @default("Türkiye")
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model Favorite {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId       String
  createdAt       DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

model Cart {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           CartItem[]
  couponCode      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variantId       String
  variant         Variant  @relation(fields: [variantId], references: [id])
  quantity        Int
  unitPrice       Float
  vatRate         Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cartId])
  @@index([variantId])
}

model Order {
  id              String   @id @default(cuid())
  orderNo         String   @unique // Human-readable order number
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?  // stripe, paytr, iyzico
  paymentProviderRef String? // Provider transaction ID
  // Shipping address
  shippingName    String
  shippingEmail   String?  // Guest order email (for invoice/confirmation)
  shippingPhone   String
  shippingAddress String
  shippingCity    String
  shippingDistrict String
  shippingPostalCode String
  shippingCountry String  @default("Türkiye")
  // Billing info
  billingType     String  // individual, company
  billingName     String
  billingTaxId   String? // TCKN or VKN
  billingTaxOffice String?
  billingAddress  String?
  billingCity     String?
  billingDistrict String?
  billingPostalCode String?
  billingCountry  String? @default("Türkiye")
  // Totals
  subtotal        Float
  vatTotal        Float
  shippingCost    Float
  discount        Float    @default(0)
  total           Float
  currency        String   @default("TRY")
  // Additional
  trackingNumber  String?
  eArsivRef       String?  // E-arşiv invoice reference
  invoicePdfUrl   String?  // Generated invoice PDF
  notes           String?
  lines           OrderLine[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderNo])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

model OrderLine {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId       String?  // Opsiyonel: teklif kalemleri (quote-*) için null
  variant         Variant? @relation(fields: [variantId], references: [id])
  productName     String   // Snapshot at order time (veya teklif açıklaması)
  variantMatrix   Json?    // Snapshot of variant matrix
  quantity        Int
  unitPrice       Float
  vatRate         Float
  lineTotal       Float
  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([variantId])
}

model RFQ {
  id              String   @id @default(cuid())
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  companyName     String
  contactName     String
  contactEmail    String
  contactPhone    String?
  status          RFQStatus @default(SUBMITTED)
  targetQty       Int?
  targetPrice     Float?
  targetCurrency  String?  @default("TRY")
  notes           String?
  items           RFQItem[]
  quotePdfUrl     String?  // Generated quote PDF
  quotedAt        DateTime?
  quotedBy        String?  // Admin user ID
  quotedMessage   String?  // Admin'den müşteriye mesaj (fiyat teklifi ile)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model RFQItem {
  id              String   @id @default(cuid())
  rfqId            String
  rfq              RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  productId       String?
  mpn             String?  // Manufacturer part number
  sku             String?  // Our SKU
  description     String
  quantity        Int
  unitPrice       Float?
  notes           String?
  serviceSlug     String?  // Hizmet slug (e.g. 3d-baski-hizmeti, mekanik-uretim)
  designFileUrl   String?  // Drive link for 3D/Mekanik design upload
  createdAt       DateTime @default(now())

  @@index([rfqId])
}

model GesQuoteRequest {
  id                     String   @id @default(cuid())
  fullName               String
  phone                  String
  city                   String
  email                  String?
  district               String?  // İlçe
  monthlyKwh             Float?
  regionId               String?
  suggestedKwp           Float?
  installationType       String?  // ev | isyeri | tarim | diger
  notes                  String?
  wantsEvChargingQuote   Boolean  @default(false)
  wantsLightingQuote     Boolean  @default(false)
  // Bölüm 1 – Mülk
  propertyType           String?  // mustakil_ev | site_villa | apartman_cati | dukkan | atolye | fabrika | tarimsal | depo | diger
  // Bölüm 2 – Elektrik
  monthlyBillRange       String?  // 0_1000 | 1000_3000 | 3000_10000 | 10000_25000 | 25k_plus
  subscriberType         String?  // mesken | ticarethane | sanayi | tarimsal_sulama
  threePhase             String?  // evet | hayir | bilmiyorum
  // Bölüm 3 – Kurulum alanı
  installationAreaType   String?  // cati | arazi | carport | cephe | bilmiyorum
  roofType               String?  // betonarme_duz | kiremit | sandvic | trapez | bilmiyorum
  roofAreaRange          String?  // 0_50 | 50_100 | 100_250 | 250_plus
  shading                String?  // hayir | baca | agac | komsu | emin_degilim
  deedStatus             String?  // kendi | kiracı | ortak
  // Bölüm 4 – Sistem
  usageGoal              String?  // virgülle ayrılmış: fatura_sifir | satis | kismi_tasarruf | yedekleme | offgrid
  storagePreference      String?  // hayir | evet_kesinti | evet_enerji_satis | kararsiz
  budgetRange            String?  // 100k_alti | 100_300k | 300_1000k | 1m_ustu | teklif_istiyorum
  financing              String?  // pesin | kredi | leasing | devlet_tesvik
  // Onay
  kvkkAccepted           Boolean? @default(false)
  callAccepted           Boolean? @default(false)
  // Dosyalar
  attachmentPanelUrl     String?
  attachmentBillUrl     String?
  attachmentRoofUrl     String?
  // Ticari ek (opsiyonel)
  formData               Json?   // workingHours, demandKw, hasCompensation, hasRoofProject, distributor vb.
  createdAt              DateTime @default(now())

  @@index([createdAt])
}

model GesQuoteVerification {
  id                        String   @id @default(cuid())
  companyName               String
  quoteDate                 DateTime?
  totalPriceTry             Float?
  turnkey                   String?  // evet | hayir | emin_degilim
  panelBrandModel           String?
  panelWatt                 Int?
  panelCount                Int?
  totalKwp                  Float?
  panelTechnology           String?
  panelCertifications       String?
  panelEfficiencyPct        Float?
  warrantyProductYears      Int?
  warrantyPerformanceYears  Int?
  warrantyPerformance25Pct   Float?
  inverterBrandModel        String?
  inverterTotalKw           Float?
  inverterType              String?
  mpptCount                 Int?
  storageCompatible         String?
  batteryBrandModel         String?
  batteryKwh                Float?
  batteryChemistry          String?
  mountingType              String?
  staticProjectProvided     String?
  electricalIncluded        String?
  annualProductionKwh       Float?
  paybackYearsQuoted        Float?
  warrantyService           String?
  smartEMS                  String?
  attachmentBillUrl         String?
  attachmentQuotePdfUrl     String?
  contactName               String?
  contactEmail              String?
  contactPhone              String?
  redFlags                  Json?   // string[] hesaplanan bayraklar
  scoreTotal                Int?
  createdAt                 DateTime @default(now())

  @@index([createdAt])
}

model BOMUpload {
  id              String   @id @default(cuid())
  userId          String?
  fileName        String
  fileUrl         String
  matchedItems    Json     // Array of matched items
  unmatchedItems  Json     // Array of unmatched items with suggestions
  createdAt       DateTime @default(now())

  @@index([userId])
}

// Product Reviews and Ratings
model Review {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  rating      Int      // 1-5 stars
  title       String?
  comment     String
  images      Json?    // [{url, alt}] - Review photos
  helpful     Int      @default(0) // Helpful count
  verified    Boolean  @default(false) // Verified purchase
  status      String   @default("pending") // pending, approved, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([rating])
}

// Product Questions and Answers
model ProductQuestion {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  question    String
  answer      String?
  answeredBy  String?  // Admin user ID
  answeredAt  DateTime?
  helpful     Int      @default(0) // Helpful count
  status      String   @default("pending") // pending, answered, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([userId])
  @@index([status])
}

// Site mock ürünleri için stok override (admin günceller, frontend bu değeri kullanır)
model StockOverride {
  id        String   @id @default(cuid())
  productId String   @unique // mock product id (örn. sizdirmazlik-1, sizdirmazlik-pro)
  stock     Int      @default(0)
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// Admin tanımlı indirimler (kapsam: tüm / kategori / ürün)
model Discount {
  id           String    @id @default(cuid())
  name         String
  scope        String    // ALL | CATEGORY | PRODUCT
  categoryName String?
  productIds   Json?     // ["hims-hcdkb-22", ...]
  type         String    // PERCENT | FIXED
  value        Float
  startDate    DateTime?
  endDate      DateTime?
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([active])
  @@index([scope])
}

// Site kataloğu override: mock ürün düzenleme veya yeni ürün (admin)
model ProductOverride {
  id              String   @id @default(cuid())
  productId       String   @unique // mock product id veya yeni ürün için cuid
  name            String?
  slug            String?
  description     String?
  fullDescription String?
  price           Float?
  image           String?
  images          Json?    // string[]
  category        String?
  stock           Int?
  featured        Boolean?
  specifications  Json?
  features        Json?    // string[]
  variants        Json?    // { key, label, price, sku }[]
  brand           String?
  sku             String?
  tags            Json?    // string[]
  slogan          String?
  warranty        String?
  updatedAt       DateTime @updatedAt

  @@index([productId])
}

// Legacy Product model (for backward compatibility)
model LegacyProduct {
  id          String  @id @default(cuid())
  name        String
  description String
  fullDescription String?
  price       Float
  image       String?
  category    String
  voltage     String?
  capacity    String?
  chemistry   String?
  stock       Int      @default(0)
  featured    Boolean  @default(false)
  specifications Json? // JSON object for specifications
  features    Json?    // JSON array for features
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
