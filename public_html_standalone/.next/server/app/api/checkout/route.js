"use strict";(()=>{var e={};e.id=1607,e.ids=[1607],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},93540:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>I,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{POST:()=>p});var i=r(95419),o=r(69108),n=r(99678),s=r(78070),d=r(3214),c=r(84642);let u=[{id:"free_shipping",name:"\xdccretsiz Kargo",priority:100,conditions:{},cost:{base:0,freeThreshold:1e3}},{id:"standard",name:"Standart Kargo",priority:50,conditions:{weightMax:5e3},cost:{base:50,perKg:5}},{id:"heavy",name:"Ağır Paket",priority:60,conditions:{weightMin:5e3,weightMax:2e4},cost:{base:100,perKg:8}},{id:"dangerous",name:"Tehlikeli Madde (Ak\xfc)",priority:90,conditions:{isDangerous:!0},cost:{base:150,perKg:10}}];class l{constructor(e){this.rules=e||u,this.rules.sort((e,t)=>t.priority-e.priority)}calculate(e){let t=e.items.reduce((e,t)=>e+t.weightG,0),r=e.items.reduce((e,t)=>e+(t.volumeCm3||0),0),a=e.items.some(e=>e.isDangerous),i=e.items.some(e=>e.isFragile),o=this.rules.find(t=>t.cost.freeThreshold&&e.orderTotal>=t.cost.freeThreshold);if(o)return{cost:0,estimatedDays:3,ruleId:o.id,freeShipping:!0};for(let o of this.rules)if(this.matchesRule(o,e,t,r,a,i))return{cost:this.calculateCost(o,t,r),estimatedDays:this.estimateDays(o,e.shippingAddress),carrier:o.carriers?.[0],ruleId:o.id,freeShipping:!1};return{cost:100,estimatedDays:5,ruleId:"default",freeShipping:!1}}matchesRule(e,t,r,a,i,o){let{conditions:n}=e;return(void 0===n.weightMin||!(r<n.weightMin))&&(void 0===n.weightMax||!(r>n.weightMax))&&(void 0===n.volumeMin||!(a<n.volumeMin))&&(void 0===n.volumeMax||!(a>n.volumeMax))&&(!n.categoryIds||!(n.categoryIds.length>0)||!!t.items.map(e=>e.categoryId).filter(Boolean).some(e=>n.categoryIds.includes(e)))&&(void 0===n.isDangerous||n.isDangerous===i)&&(void 0===n.isFragile||n.isFragile===o)}calculateCost(e,t,r){let a=e.cost.base||0;return e.cost.perKg&&(a+=t/1e3*e.cost.perKg),e.cost.perVolume&&(a+=r*e.cost.perVolume),Math.round(100*a)/100}estimateDays(e,t){return"T\xfcrkiye"!==t.country?7:["İstanbul","Ankara","İzmir","Bursa","Antalya"].includes(t.city)?2:3}}async function p(e){try{let{cartItems:t,shippingAddress:r,billingAddress:a,billingType:i,paymentProvider:o,couponCode:n}=await e.json();if(!t||0===t.length)return s.Z.json({error:"Cart is empty"},{status:400});let u=await d._.variant.findMany({where:{id:{in:t.map(e=>e.variantId)}},include:{product:!0,stock:!0}}),p=t.map(e=>{let t=u.find(t=>t.id===e.variantId);if(!t)throw Error(`Variant not found: ${e.variantId}`);return{variantId:e.variantId,quantity:e.quantity,unitPrice:Number(t.price),vatRate:Number(t.vatRate),moq:t.product.moq||void 0,orderStep:t.product.orderStep||void 0,availableStock:(t.stock?.onHand||0)-(t.stock?.reserved||0)}}),h=new l().calculate({items:p.map(e=>({weightG:u.find(t=>t.id===e.variantId)?.weightG||0,categoryId:u.find(t=>t.id===e.variantId)?.product?.categoryId||void 0,isDangerous:!0})),orderTotal:0,shippingAddress:r}),m=function(e,t=0,r=0){let a=e.map(e=>{let t=e.unitPrice*e.quantity,r=e.vatRate/100*t;return{variantId:e.variantId,quantity:e.quantity,unitPrice:e.unitPrice,vatRate:e.vatRate,lineSubtotal:Math.round(100*t)/100,lineVat:Math.round(100*r)/100,lineTotal:Math.round(100*(t+r))/100}}),i=a.reduce((e,t)=>e+t.lineSubtotal,0),o=a.reduce((e,t)=>e+t.lineVat,0),n=function(e){let t=[],r=[];return e.forEach(e=>{e.moq&&e.quantity<e.moq&&t.push(`Minimum sipariş miktarı ${e.moq} adet. Se\xe7ilen: ${e.quantity} adet.`),e.orderStep&&e.orderStep>1&&e.quantity%e.orderStep!=0&&t.push(`Sipariş miktarı ${e.orderStep}'in katı olmalıdır. Se\xe7ilen: ${e.quantity} adet.`),void 0!==e.availableStock&&e.quantity>e.availableStock&&t.push(`Yeterli stok yok. Mevcut: ${e.availableStock} adet, İstenen: ${e.quantity} adet.`),void 0!==e.availableStock&&e.availableStock<10&&e.availableStock>0&&r.push(`D\xfcş\xfck stok uyarısı: Sadece ${e.availableStock} adet kaldı.`)}),{valid:0===t.length,errors:t,warnings:r}}(e);return{items:a,subtotal:Math.round(100*i)/100,vatTotal:Math.round(100*o)/100,shippingCost:Math.round(100*t)/100,discount:Math.round(100*r)/100,total:Math.round(100*(i+o+t-r))/100,errors:n.errors,warnings:n.warnings}}(p,h.cost,0);if(m.errors.length>0)return s.Z.json({errors:m.errors},{status:400});let y=`ORD-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,v=await d._.order.create({data:{orderNo:y,userId:void 0,status:"PENDING",paymentStatus:"PENDING",shippingName:r.name,shippingPhone:r.phone,shippingAddress:r.addressLine,shippingCity:r.city,shippingDistrict:r.district||"",shippingPostalCode:r.postalCode,shippingCountry:r.country||"T\xfcrkiye",billingType:i||"individual",billingName:a.name,billingTaxId:a.taxId,billingTaxOffice:a.taxOffice,billingAddress:a.address,billingCity:a.city,billingDistrict:a.district,billingPostalCode:a.postalCode,billingCountry:a.country||"T\xfcrkiye",subtotal:m.subtotal,vatTotal:m.vatTotal,shippingCost:m.shippingCost,discount:m.discount,total:m.total,lines:{create:m.items.map(e=>{let t=u.find(t=>t.id===e.variantId);return{variantId:t.id,productName:t.product.name,variantMatrix:t.matrix,quantity:e.quantity,unitPrice:e.unitPrice,vatRate:e.vatRate,lineTotal:e.lineTotal}})}}});for(let e of p)await d._.stock.update({where:{variantId:e.variantId},data:{reserved:{increment:e.quantity}}});if(o){let e=(0,c.z)(o),t=await e.initPayment({orderId:v.id,amount:Number(m.total),currency:"TRY",customer:{email:r.email,name:r.name,phone:r.phone},billing:a,metadata:{orderNo:v.orderNo}});return await d._.order.update({where:{id:v.id},data:{paymentMethod:o,paymentProviderRef:t.providerRef}}),s.Z.json({orderId:v.id,orderNo:v.orderNo,payment:t})}return s.Z.json({orderId:v.id,orderNo:v.orderNo})}catch(e){return console.error("Checkout error:",e),s.Z.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:"app/api/checkout/route"},resolvedPagePath:"C:\\Users\\aslan\\Desktop\\masa\xfcst\xfc-10.25\\DIY_battery\\app\\api\\checkout\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:v,headerHooks:g,staticGenerationBailout:f}=h,I="/api/checkout/route";function w(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},84642:(e,t,r)=>{r.d(t,{z:()=>l});var a=r(91211);let i=null;function o(){if(!i){if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");i=new a.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia"})}return i}class n{async initPayment(e){try{let t=o(),r=await t.paymentIntents.create({amount:Math.round(100*e.amount),currency:e.currency.toLowerCase(),customer_email:e.customer.email,metadata:{orderId:e.orderId,...e.metadata},automatic_payment_methods:{enabled:!0}});return{clientSecret:r.client_secret||void 0,providerRef:r.id,requiresRedirect:!1}}catch(e){throw console.error("Stripe payment init error:",e),Error(`Stripe payment initialization failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async verifyWebhook(e){let t=e.headers.get("stripe-signature");if(!t||!process.env.STRIPE_WEBHOOK_SECRET)throw Error("Missing Stripe webhook signature or secret");let r=await e.text();try{let e=o().webhooks.constructEvent(r,t,process.env.STRIPE_WEBHOOK_SECRET);if("payment_intent.succeeded"===e.type){let t=e.data.object;return{orderId:t.metadata.orderId||"",status:"PAID",providerRef:t.id,amount:t.amount/100,currency:t.currency.toUpperCase()}}if("payment_intent.payment_failed"===e.type){let t=e.data.object;return{orderId:t.metadata.orderId||"",status:"FAILED",providerRef:t.id,amount:t.amount/100,currency:t.currency.toUpperCase()}}throw Error(`Unhandled event type: ${e.type}`)}catch(e){throw console.error("Stripe webhook verification error:",e),Error(`Webhook verification failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getPaymentStatus(e){try{let t=o(),r=await t.paymentIntents.retrieve(e),a="PENDING";return"succeeded"===r.status?a="PAID":("canceled"===r.status||"payment_failed"===r.status)&&(a="FAILED"),{orderId:r.metadata.orderId||"",status:a,providerRef:r.id,amount:r.amount/100,currency:r.currency.toUpperCase()}}catch(e){throw console.error("Stripe get payment status error:",e),Error(`Failed to get payment status: ${e instanceof Error?e.message:"Unknown error"}`)}}async refund(e,t){try{let r=o(),a=await r.refunds.create({payment_intent:e,amount:t?Math.round(100*t):void 0});return{success:"succeeded"===a.status,refundRef:a.id}}catch(e){return console.error("Stripe refund error:",e),{success:!1}}}}var s=r(6113),d=r.n(s);class c{constructor(){this.merchantId=process.env.PAYTR_MERCHANT_ID||"mock_merchant_id",this.merchantKey=process.env.PAYTR_MERCHANT_KEY||"mock_merchant_key",this.merchantSalt=process.env.PAYTR_MERCHANT_SALT||"mock_merchant_salt"}generateHash(e){return d().createHash("sha256").update(e+this.merchantSalt).digest("base64")}async initPayment(e){let t=`ORDER_${e.orderId}_${Date.now()}`,r=`${this.merchantId}${t}${e.customer.email}${Math.round(100*e.amount)}${this.merchantSalt}`,a=this.generateHash(r);return{redirectUrl:`https://www.paytr.com/odeme?merchantOid=${t}&hash=${a}`,providerRef:t,requiresRedirect:!0}}async verifyWebhook(e){let{merchant_oid:t,status:r,total_amount:a,hash:i}=await e.json(),o=`${t}${this.merchantSalt}${r}${a}`;if(this.generateHash(o)!==i)throw Error("Invalid PayTR webhook hash");let n=t.split("_")[1],s="PENDING";return"success"===r?s="PAID":"failed"===r&&(s="FAILED"),{orderId:n,status:s,providerRef:t,amount:parseFloat(a)/100,currency:"TRY"}}async getPaymentStatus(e){return{orderId:e.split("_")[1]||"",status:"PENDING",providerRef:e,amount:0,currency:"TRY"}}}class u{constructor(){this.apiKey=process.env.IYZICO_API_KEY||"mock_api_key",this.secretKey=process.env.IYZICO_SECRET_KEY||"mock_secret_key"}generateHash(e){return d().createHash("sha256").update(e+this.secretKey).digest("hex")}async initPayment(e){let t=`CONV_${e.orderId}_${Date.now()}`,r=`${this.apiKey}${t}${Math.round(100*e.amount)}${this.secretKey}`,a=this.generateHash(r);return{redirectUrl:`https://sandbox-api.iyzipay.com/payment/auth?conversationId=${t}&hash=${a}`,providerRef:t,requiresRedirect:!0}}async verifyWebhook(e){let{conversationId:t,paymentStatus:r,paidPrice:a,hash:i}=await e.json(),o=`${this.apiKey}${t}${r}${a}${this.secretKey}`;if(this.generateHash(o)!==i)throw Error("Invalid iyzico webhook hash");let n=t.split("_")[1],s="PENDING";return"SUCCESS"===r?s="PAID":"FAILURE"===r&&(s="FAILED"),{orderId:n,status:s,providerRef:t,amount:parseFloat(a)/100,currency:"TRY"}}async getPaymentStatus(e){return{orderId:e.split("_")[1]||"",status:"PENDING",providerRef:e,amount:0,currency:"TRY"}}}function l(e){switch(e){case"stripe":return new n;case"paytr":return new c;case"iyzico":return new u;default:throw Error(`Unknown payment provider: ${e}`)}}},3214:(e,t,r)=>{r.d(t,{_:()=>i});var a=r(53524);let i=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,1211],()=>r(93540));module.exports=a})();