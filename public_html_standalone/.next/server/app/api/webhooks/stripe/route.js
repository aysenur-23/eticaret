"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},99419:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>_,patchFetch:()=>I,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>l,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>E});var a={};t.r(a),t.d(a,{POST:()=>d});var s=t(95419),o=t(69108),n=t(99678),i=t(78070),c=t(84642),u=t(3214);async function d(e){try{let r=(0,c.z)("stripe"),t=await r.verifyWebhook(e),a=await u._.order.findFirst({where:{OR:[{id:t.orderId},{paymentProviderRef:t.providerRef}]}});return a&&(await u._.order.update({where:{id:a.id},data:{paymentStatus:"PAID"===t.status?"PAID":"FAILED",status:"PAID"===t.status?"PAID":"PENDING"}}),t.status),i.Z.json({received:!0})}catch(e){return console.error("Stripe webhook error:",e),i.Z.json({error:"Webhook processing failed"},{status:400})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"C:\\Users\\aslan\\Desktop\\masa\xfcst\xfc-10.25\\DIY_battery\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:l,headerHooks:y,staticGenerationBailout:E}=p,_="/api/webhooks/stripe/route";function I(){return(0,n.patchFetch)({serverHooks:l,staticGenerationAsyncStorage:m})}},84642:(e,r,t)=>{t.d(r,{z:()=>p});var a=t(91211);let s=null;function o(){if(!s){if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");s=new a.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia"})}return s}class n{async initPayment(e){try{let r=o(),t=await r.paymentIntents.create({amount:Math.round(100*e.amount),currency:e.currency.toLowerCase(),customer_email:e.customer.email,metadata:{orderId:e.orderId,...e.metadata},automatic_payment_methods:{enabled:!0}});return{clientSecret:t.client_secret||void 0,providerRef:t.id,requiresRedirect:!1}}catch(e){throw console.error("Stripe payment init error:",e),Error(`Stripe payment initialization failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async verifyWebhook(e){let r=e.headers.get("stripe-signature");if(!r||!process.env.STRIPE_WEBHOOK_SECRET)throw Error("Missing Stripe webhook signature or secret");let t=await e.text();try{let e=o().webhooks.constructEvent(t,r,process.env.STRIPE_WEBHOOK_SECRET);if("payment_intent.succeeded"===e.type){let r=e.data.object;return{orderId:r.metadata.orderId||"",status:"PAID",providerRef:r.id,amount:r.amount/100,currency:r.currency.toUpperCase()}}if("payment_intent.payment_failed"===e.type){let r=e.data.object;return{orderId:r.metadata.orderId||"",status:"FAILED",providerRef:r.id,amount:r.amount/100,currency:r.currency.toUpperCase()}}throw Error(`Unhandled event type: ${e.type}`)}catch(e){throw console.error("Stripe webhook verification error:",e),Error(`Webhook verification failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getPaymentStatus(e){try{let r=o(),t=await r.paymentIntents.retrieve(e),a="PENDING";return"succeeded"===t.status?a="PAID":("canceled"===t.status||"payment_failed"===t.status)&&(a="FAILED"),{orderId:t.metadata.orderId||"",status:a,providerRef:t.id,amount:t.amount/100,currency:t.currency.toUpperCase()}}catch(e){throw console.error("Stripe get payment status error:",e),Error(`Failed to get payment status: ${e instanceof Error?e.message:"Unknown error"}`)}}async refund(e,r){try{let t=o(),a=await t.refunds.create({payment_intent:e,amount:r?Math.round(100*r):void 0});return{success:"succeeded"===a.status,refundRef:a.id}}catch(e){return console.error("Stripe refund error:",e),{success:!1}}}}var i=t(6113),c=t.n(i);class u{constructor(){this.merchantId=process.env.PAYTR_MERCHANT_ID||"mock_merchant_id",this.merchantKey=process.env.PAYTR_MERCHANT_KEY||"mock_merchant_key",this.merchantSalt=process.env.PAYTR_MERCHANT_SALT||"mock_merchant_salt"}generateHash(e){return c().createHash("sha256").update(e+this.merchantSalt).digest("base64")}async initPayment(e){let r=`ORDER_${e.orderId}_${Date.now()}`,t=`${this.merchantId}${r}${e.customer.email}${Math.round(100*e.amount)}${this.merchantSalt}`,a=this.generateHash(t);return{redirectUrl:`https://www.paytr.com/odeme?merchantOid=${r}&hash=${a}`,providerRef:r,requiresRedirect:!0}}async verifyWebhook(e){let{merchant_oid:r,status:t,total_amount:a,hash:s}=await e.json(),o=`${r}${this.merchantSalt}${t}${a}`;if(this.generateHash(o)!==s)throw Error("Invalid PayTR webhook hash");let n=r.split("_")[1],i="PENDING";return"success"===t?i="PAID":"failed"===t&&(i="FAILED"),{orderId:n,status:i,providerRef:r,amount:parseFloat(a)/100,currency:"TRY"}}async getPaymentStatus(e){return{orderId:e.split("_")[1]||"",status:"PENDING",providerRef:e,amount:0,currency:"TRY"}}}class d{constructor(){this.apiKey=process.env.IYZICO_API_KEY||"mock_api_key",this.secretKey=process.env.IYZICO_SECRET_KEY||"mock_secret_key"}generateHash(e){return c().createHash("sha256").update(e+this.secretKey).digest("hex")}async initPayment(e){let r=`CONV_${e.orderId}_${Date.now()}`,t=`${this.apiKey}${r}${Math.round(100*e.amount)}${this.secretKey}`,a=this.generateHash(t);return{redirectUrl:`https://sandbox-api.iyzipay.com/payment/auth?conversationId=${r}&hash=${a}`,providerRef:r,requiresRedirect:!0}}async verifyWebhook(e){let{conversationId:r,paymentStatus:t,paidPrice:a,hash:s}=await e.json(),o=`${this.apiKey}${r}${t}${a}${this.secretKey}`;if(this.generateHash(o)!==s)throw Error("Invalid iyzico webhook hash");let n=r.split("_")[1],i="PENDING";return"SUCCESS"===t?i="PAID":"FAILURE"===t&&(i="FAILED"),{orderId:n,status:i,providerRef:r,amount:parseFloat(a)/100,currency:"TRY"}}async getPaymentStatus(e){return{orderId:e.split("_")[1]||"",status:"PENDING",providerRef:e,amount:0,currency:"TRY"}}}function p(e){switch(e){case"stripe":return new n;case"paytr":return new u;case"iyzico":return new d;default:throw Error(`Unknown payment provider: ${e}`)}}},3214:(e,r,t)=>{t.d(r,{_:()=>s});var a=t(53524);let s=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,1211],()=>t(99419));module.exports=a})();